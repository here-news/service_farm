version: '3.8'

# Service Farm - Split Containers
# ================================
# API and Workers run in separate containers.
# Database infrastructure managed by ../infra repo (remote server).
#
# Usage:
#   docker-compose up -d                    # Start both app and workers
#   docker-compose up -d app                # Start app only (API + frontend)
#   docker-compose up -d workers            # Start workers only
#   docker-compose logs -f app              # Follow app logs
#   docker-compose logs -f workers          # Follow worker logs
#
# Dev mode (API with hot reload):
#   docker-compose up app                   # App with mounted source
#
# Scale workers:
#   docker-compose up -d --scale workers=2  # Run 2 worker containers
#
# Containers:
#   - app: FastAPI server (uvicorn on port 7272) + static frontend
#   - workers: extraction, knowledge, weaver, inquiry workers

services:
  # ═══════════════════════════════════════════════════════════════
  # APP Container - FastAPI + Static Frontend
  # ═══════════════════════════════════════════════════════════════
  app:
    build:
      context: .
      dockerfile: Dockerfile.app
    container_name: herenews-app
    network_mode: host
    env_file: .env
    volumes:
      - ./backend:/app
      - ./frontend/prototypes:/app/prototypes
    command: uvicorn main:app --host 0.0.0.0 --port 7272
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7272/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ═══════════════════════════════════════════════════════════════
  # Workers Container - Background Processing
  # ═══════════════════════════════════════════════════════════════
  workers:
    build:
      context: .
      dockerfile: Dockerfile.app
    container_name: herenews-workers
    network_mode: host
    env_file: .env
    volumes:
      - ./backend:/app
    # Run all workers except API
    command: python run_workers.py --no-api --workers 1
    restart: unless-stopped
    depends_on:
      - app

