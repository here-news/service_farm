version: '3.8'

# Service Farm - Unified Single Container
# ========================================
# All workers run as processes inside one container.
# Database infrastructure managed by ../infra repo.
#
# Usage:
#   docker-compose up -d                    # Start all workers (default)
#   docker-compose logs -f app              # Follow all logs
#
# Dev mode (API only with hot reload):
#   docker-compose run --rm app uvicorn main:app --host 0.0.0.0 --port 7272 --reload
#
# Run specific workers:
#   docker-compose exec app python run_workers.py --only api
#   docker-compose exec app python run_workers.py --only extraction
#   docker-compose exec app python run_workers.py --only knowledge
#   docker-compose exec app python run_workers.py --only event
#   docker-compose exec app python run_workers.py --only inquiry
#
# Workers included:
#   - api: FastAPI server (uvicorn on port 7272)
#   - extraction: Page content extraction
#   - knowledge: Entity extraction + Wikidata linking
#   - event: Neo4j event weaving (creates Surfaces)
#   - inquiry: Inquiry resolution checker (consumes Surfaces)

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile.app
    container_name: herenews-app
    network_mode: host
    env_file: .env
    # Note: env_file loads all vars from .env
    # No 'environment:' section needed - it would override with host shell values
    volumes:
      - ./backend:/app
      - ./frontend/prototypes:/app/prototypes
    # Run all workers (API + extraction + knowledge + event + inquiry)
    command: python run_workers.py --workers 1
