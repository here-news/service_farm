version: '3.8'

# Service Farm - Application Layer Only
# ======================================
# Database infrastructure managed by ../infra repo
# Remote DBs accessed via IPv6 (Yggdrasil) or local network
#
# Usage:
#   docker-compose up -d              # Start app + workers
#   docker-compose up -d app          # Start app only
#   docker-compose logs -f worker-event  # Follow worker logs

services:
  # ============================================
  # APPLICATION SERVICES
  # Connect to remote/infra DBs via environment
  # ============================================

  # Unified App (FastAPI backend + React frontend built-in)
  app:
    build:
      context: .
      dockerfile: Dockerfile.app
    container_name: herenews-app
    network_mode: host
    environment:
      POSTGRES_HOST: ${POSTGRES_HOST}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      POSTGRES_DB: ${POSTGRES_DB:-phi_here}
      POSTGRES_USER: ${POSTGRES_USER:-phi_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      REDIS_URL: ${REDIS_URL}
      NEO4J_URI: ${NEO4J_URI}
      NEO4J_USER: ${NEO4J_USER:-neo4j}
      NEO4J_PASSWORD: ${NEO4J_PASSWORD}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      IFRAMELY_API_KEY: ${IFRAMELY_API_KEY}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
    volumes:
      - ./backend:/app
    command: uvicorn main:app --host 0.0.0.0 --port 7272 --reload

  # Extraction Workers (parallel processing)
  worker-extraction-1:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: herenews-worker-extraction-1
    network_mode: host
    environment:
      POSTGRES_HOST: ${POSTGRES_HOST}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      POSTGRES_DB: ${POSTGRES_DB:-phi_here}
      POSTGRES_USER: ${POSTGRES_USER:-phi_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      REDIS_URL: ${REDIS_URL}
      WORKER_ID: "1"
    volumes:
      - ./backend:/app
    command: python run_extraction_worker.py

  worker-extraction-2:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: herenews-worker-extraction-2
    network_mode: host
    environment:
      POSTGRES_HOST: ${POSTGRES_HOST}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      POSTGRES_DB: ${POSTGRES_DB:-phi_here}
      POSTGRES_USER: ${POSTGRES_USER:-phi_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      REDIS_URL: ${REDIS_URL}
      WORKER_ID: "2"
    volumes:
      - ./backend:/app
    command: python run_extraction_worker.py

  # Knowledge Workers (entity extraction + Wikidata enrichment)
  worker-knowledge-1:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: herenews-worker-knowledge-1
    network_mode: host
    environment:
      POSTGRES_HOST: ${POSTGRES_HOST}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      POSTGRES_DB: ${POSTGRES_DB:-phi_here}
      POSTGRES_USER: ${POSTGRES_USER:-phi_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      REDIS_URL: ${REDIS_URL}
      NEO4J_URI: ${NEO4J_URI}
      NEO4J_USER: ${NEO4J_USER:-neo4j}
      NEO4J_PASSWORD: ${NEO4J_PASSWORD}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      WORKER_NAME: knowledge-1
    volumes:
      - ./backend:/app
    command: python run_knowledge_worker.py

  worker-knowledge-2:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: herenews-worker-knowledge-2
    network_mode: host
    environment:
      POSTGRES_HOST: ${POSTGRES_HOST}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      POSTGRES_DB: ${POSTGRES_DB:-phi_here}
      POSTGRES_USER: ${POSTGRES_USER:-phi_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      REDIS_URL: ${REDIS_URL}
      NEO4J_URI: ${NEO4J_URI}
      NEO4J_USER: ${NEO4J_USER:-neo4j}
      NEO4J_PASSWORD: ${NEO4J_PASSWORD}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      WORKER_NAME: knowledge-2
    volumes:
      - ./backend:/app
    command: python run_knowledge_worker.py

  # Event Worker (Neo4j-based graph scaffold)
  worker-event:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: herenews-worker-event
    network_mode: host
    environment:
      POSTGRES_HOST: ${POSTGRES_HOST}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      POSTGRES_DB: ${POSTGRES_DB:-phi_here}
      POSTGRES_USER: ${POSTGRES_USER:-phi_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      REDIS_URL: ${REDIS_URL}
      NEO4J_URI: ${NEO4J_URI}
      NEO4J_USER: ${NEO4J_USER:-neo4j}
      NEO4J_PASSWORD: ${NEO4J_PASSWORD}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      WORKER_ID: "1"
    volumes:
      - ./backend:/app
    command: python run_event_worker_neo4j.py
