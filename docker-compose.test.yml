# Test environment with local Neo4j for kernel validation
# Usage:
#   docker-compose -f docker-compose.test.yml up -d neo4j-test
#   pytest backend/reee/tests/integration/ -v
#   docker-compose -f docker-compose.test.yml down

services:
  neo4j-test:
    image: neo4j:5.15-community
    container_name: herenews-neo4j-test
    ports:
      - "7688:7687"  # Bolt (different from prod 7687)
      - "7475:7474"  # HTTP (different from prod 7474)
    environment:
      NEO4J_AUTH: neo4j/test_password
      NEO4J_PLUGINS: '["apoc"]'
      # Performance settings for test
      NEO4J_dbms_memory_heap_initial__size: 256m
      NEO4J_dbms_memory_heap_max__size: 512m
      NEO4J_dbms_memory_pagecache_size: 128m
    volumes:
      - neo4j-test-data:/data
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:7474 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # PostgreSQL for embedding storage (optional - can use SQLite mock)
  postgres-test:
    image: postgres:15
    container_name: herenews-postgres-test
    ports:
      - "5433:5432"  # Different from prod 5432
    environment:
      POSTGRES_USER: phi_user
      POSTGRES_PASSWORD: test_password
      POSTGRES_DB: phi_here_test
    volumes:
      - postgres-test-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U phi_user -d phi_here_test"]
      interval: 5s
      timeout: 3s
      retries: 5

volumes:
  neo4j-test-data:
  postgres-test-data:
