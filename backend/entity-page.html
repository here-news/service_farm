<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entity - HERE.news</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0f;
            color: #e0e0e0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 24px;
            border-bottom: 1px solid #222;
            background: #111118;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .back-btn {
            color: #888;
            text-decoration: none;
            font-size: 14px;
        }

        .back-btn:hover { color: #fff; }

        .logo {
            font-size: 18px;
            font-weight: bold;
            color: #fff;
        }

        .logo span { color: #4CAF50; }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .nav-links {
            display: flex;
            gap: 20px;
        }

        .nav-links a {
            color: #888;
            text-decoration: none;
            font-size: 14px;
        }

        .nav-links a:hover { color: #fff; }

        /* Entity Header */
        .entity-header {
            padding: 20px 24px;
            background: linear-gradient(135deg, #1a2a1e 0%, #111118 100%);
            border-bottom: 1px solid #222;
        }

        .entity-title {
            font-size: 26px;
            font-weight: 600;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .entity-type-badge {
            font-size: 11px;
            padding: 3px 10px;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .type-PERSON { background: #2196F3; color: white; }
        .type-ORGANIZATION { background: #9C27B0; color: white; }
        .type-LOCATION { background: #FF9800; color: white; }
        .type-CONCEPT { background: #607D8B; color: white; }

        .qualia-badge {
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
            color: white;
            font-size: 11px;
            padding: 3px 10px;
            border-radius: 4px;
            font-weight: 600;
            animation: glow 2s infinite;
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px #4CAF50; }
            50% { box-shadow: 0 0 15px #4CAF50; }
        }

        .entity-profile {
            font-size: 15px;
            color: #4CAF50;
            margin: 8px 0 12px;
            font-style: italic;
        }

        .entity-meta {
            display: flex;
            gap: 20px;
            font-size: 13px;
            color: #888;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .meta-value {
            color: #ddd;
            font-weight: 500;
        }

        /* Main Split Pane */
        .main {
            display: grid;
            grid-template-columns: 1fr 360px;
            flex: 1;
            overflow: hidden;
        }

        /* Content Pane (Left) */
        .content-pane {
            padding: 24px;
            overflow-y: auto;
            border-right: 1px solid #222;
        }

        /* Cards */
        .card {
            background: #14141c;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #222;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 13px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-title-icon {
            font-size: 16px;
        }

        /* Symbiosis Visualization */
        .symbiosis-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            text-align: center;
        }

        .symbiosis-stat {
            background: #1a1a28;
            padding: 16px;
            border-radius: 8px;
        }

        .symbiosis-value {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
        }

        .symbiosis-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            margin-top: 4px;
        }

        /* Related Events */
        .event-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .event-item {
            background: #1a1a28;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .event-item:hover {
            border-color: #4CAF50;
            background: #1e2a22;
        }

        .event-item-title {
            font-size: 15px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .event-item-byline {
            font-size: 13px;
            color: #4CAF50;
            margin-bottom: 8px;
        }

        .event-item-meta {
            display: flex;
            gap: 16px;
            font-size: 12px;
            color: #666;
        }

        /* Side Pane (Right) */
        .side-pane {
            padding: 20px;
            overflow-y: auto;
            background: #0d0d12;
        }

        .side-card {
            background: #14141c;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid #222;
        }

        .side-card-title {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        /* Claims List */
        .claim-item {
            padding: 10px 0;
            border-bottom: 1px solid #222;
            font-size: 13px;
            line-height: 1.5;
            color: #bbb;
        }

        .claim-item:last-child {
            border-bottom: none;
        }

        /* Entity List (for browsing) */
        .entity-browser {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .entity-browser-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: #1a1a28;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .entity-browser-item:hover {
            background: #242438;
        }

        .entity-browser-item.active {
            background: #1e3a2e;
            border: 1px solid #4CAF50;
        }

        .entity-browser-name {
            font-size: 14px;
        }

        .entity-browser-count {
            font-size: 12px;
            color: #666;
        }

        /* Loading State */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid #333;
            border-top-color: #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 12px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <a href="/" class="back-btn">< Back</a>
            <div class="logo">HERE<span>.news</span></div>
        </div>
        <div class="header-right">
            <div class="nav-links">
                <a href="/">Events</a>
                <a href="/entity" style="color: #4CAF50;">Entities</a>
                <a href="/demo">Demo</a>
            </div>
        </div>
    </div>

    <div class="entity-header" id="entityHeader">
        <div class="loading">
            <div class="spinner"></div>
            Select an entity to view
        </div>
    </div>

    <div class="main">
        <div class="content-pane" id="contentPane">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-title-icon">&#127760;</span>
                        Entity-Event Symbiosis
                    </div>
                </div>
                <div class="symbiosis-grid" id="symbiosisGrid">
                    <div class="symbiosis-stat">
                        <div class="symbiosis-value" id="eventCount">-</div>
                        <div class="symbiosis-label">Events</div>
                    </div>
                    <div class="symbiosis-stat">
                        <div class="symbiosis-value" id="claimCount">-</div>
                        <div class="symbiosis-label">Claims</div>
                    </div>
                    <div class="symbiosis-stat">
                        <div class="symbiosis-value" id="sourceCount">-</div>
                        <div class="symbiosis-label">Sources</div>
                    </div>
                    <div class="symbiosis-stat">
                        <div class="symbiosis-value" id="massValue">-</div>
                        <div class="symbiosis-label">Mass</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-title-icon">&#128240;</span>
                        Related Events
                    </div>
                </div>
                <div class="event-list" id="eventList">
                    <div class="empty-state">
                        <div class="empty-state-icon">&#128279;</div>
                        <p>No events linked yet</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="side-pane">
            <div class="side-card">
                <div class="side-card-title">Entity Organisms</div>
                <div class="entity-browser" id="entityBrowser">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading...
                    </div>
                </div>
            </div>

            <div class="side-card">
                <div class="side-card-title">Claims Mentioning Entity</div>
                <div id="claimsList">
                    <div class="empty-state">
                        Select an entity
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentEntityId = null;

        // Load entities list
        async function loadEntities() {
            try {
                const response = await fetch('/api/entities');
                const data = await response.json();
                renderEntityBrowser(data.entities);
            } catch (error) {
                console.error('Error loading entities:', error);
            }
        }

        function renderEntityBrowser(entities) {
            const container = document.getElementById('entityBrowser');

            if (!entities || entities.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>No entities yet</p>
                        <p style="font-size: 12px; margin-top: 8px;">Start the demo to see entities emerge</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = entities.slice(0, 20).map(entity => `
                <div class="entity-browser-item ${entity.id === currentEntityId ? 'active' : ''}"
                     onclick="loadEntity('${entity.id}')">
                    <div>
                        <span class="entity-browser-name">${entity.name}</span>
                        ${entity.is_qualia_capable ? '<span style="color: #4CAF50; margin-left: 4px;">&#9733;</span>' : ''}
                    </div>
                    <span class="entity-browser-count">${entity.mention_count} mentions</span>
                </div>
            `).join('');
        }

        // Load single entity
        async function loadEntity(entityId) {
            currentEntityId = entityId;

            // Update active state in browser
            document.querySelectorAll('.entity-browser-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.entity-browser-item')?.classList.add('active');

            try {
                const response = await fetch(`/api/entities/${entityId}`);
                const data = await response.json();

                if (data.error) {
                    console.error('Entity not found');
                    return;
                }

                renderEntityHeader(data.entity, data.profile);
                renderSymbiosis(data.symbiosis);
                renderRelatedEvents(data.related_events);
                renderClaims(data.all_claims);
            } catch (error) {
                console.error('Error loading entity:', error);
            }
        }

        function renderEntityHeader(entity, profile) {
            const header = document.getElementById('entityHeader');
            header.innerHTML = `
                <div class="entity-title">
                    ${entity.name}
                    <span class="entity-type-badge type-${entity.entity_type}">${entity.entity_type}</span>
                    ${entity.is_qualia_capable ? '<span class="qualia-badge">Qualia-Capable</span>' : ''}
                </div>
                ${profile ? `<div class="entity-profile">"${profile}"</div>` : ''}
                <div class="entity-meta">
                    <div class="meta-item">
                        Mentions: <span class="meta-value">${entity.mention_count}</span>
                    </div>
                    <div class="meta-item">
                        Events: <span class="meta-value">${entity.event_count}</span>
                    </div>
                    <div class="meta-item">
                        Mass: <span class="meta-value">${entity.mass}</span>
                    </div>
                    <div class="meta-item">
                        State: <span class="meta-value">${entity.state}</span>
                    </div>
                </div>
            `;
        }

        function renderSymbiosis(symbiosis) {
            document.getElementById('eventCount').textContent = symbiosis.event_count;
            document.getElementById('claimCount').textContent = symbiosis.claim_count;
            document.getElementById('sourceCount').textContent = symbiosis.source_count;
            document.getElementById('massValue').textContent = symbiosis.mass;
        }

        function renderRelatedEvents(events) {
            const container = document.getElementById('eventList');

            if (!events || events.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">&#128279;</div>
                        <p>No events linked yet</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = events.map(event => `
                <div class="event-item" onclick="window.location.href='/event?id=${event.id}'">
                    <div class="event-item-title">${event.canonical_name || event.headline || 'Event ' + event.id}</div>
                    ${event.byline ? `<div class="event-item-byline">${event.byline}</div>` : ''}
                    <div class="event-item-meta">
                        <span>&#128196; ${event.claim_count} claims</span>
                        <span>&#128101; ${event.source_count} sources</span>
                        <span>Mass: ${event.mass}</span>
                    </div>
                </div>
            `).join('');
        }

        function renderClaims(claims) {
            const container = document.getElementById('claimsList');

            if (!claims || claims.length === 0) {
                container.innerHTML = '<div class="empty-state">No claims yet</div>';
                return;
            }

            container.innerHTML = claims.slice(0, 15).map(claim => `
                <div class="claim-item">${claim}</div>
            `).join('');
        }

        // SSE for live updates
        function connectSSE() {
            const eventSource = new EventSource('/api/stream');

            eventSource.onmessage = (event) => {
                const data = JSON.parse(event.data);

                if (data.type === 'entity_fed' || data.type === 'entity_qualia') {
                    // Refresh entity list
                    loadEntities();

                    // If viewing this entity, refresh it
                    if (currentEntityId === data.entity_id) {
                        loadEntity(currentEntityId);
                    }
                }
            };

            eventSource.onerror = () => {
                setTimeout(connectSSE, 3000);
            };
        }

        // Initialize
        loadEntities();
        connectSSE();

        // Check URL for entity ID
        const urlParams = new URLSearchParams(window.location.search);
        const entityIdParam = urlParams.get('id');
        if (entityIdParam) {
            setTimeout(() => loadEntity(entityIdParam), 500);
        }
    </script>
</body>
</html>
