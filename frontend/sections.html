<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Sections - Hong Kong Fire</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            height: 100vh;
            overflow: hidden;
        }

        .header {
            background: #1a1a1a;
            border-bottom: 1px solid #333;
            padding: 16px 24px;
        }

        .event-title {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
        }

        .event-meta {
            font-size: 13px;
            color: #888;
            margin-top: 4px;
        }

        .container {
            display: flex;
            height: calc(100vh - 70px);
        }

        /* Left Panel - Section List */
        .sections-panel {
            width: 280px;
            background: #111;
            border-right: 1px solid #333;
            overflow-y: auto;
            padding: 16px;
        }

        .sections-panel h3 {
            font-size: 12px;
            text-transform: uppercase;
            color: #666;
            margin-bottom: 12px;
            letter-spacing: 0.5px;
        }

        .section-item {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .section-item:hover {
            background: #222;
            border-color: #444;
        }

        .section-item.active {
            background: #2a2a3a;
            border-color: #4a4aff;
        }

        .section-name {
            font-size: 14px;
            font-weight: 500;
            color: #fff;
            margin-bottom: 6px;
        }

        .section-type {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .section-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #333;
        }

        .page-count {
            font-size: 12px;
            color: #aaa;
        }

        .promotion-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 600;
        }

        .badge-stable {
            background: #1a3a1a;
            color: #4ade80;
        }

        .badge-review {
            background: #3a3a1a;
            color: #fbbf24;
        }

        .badge-promotable {
            background: #3a1a1a;
            color: #f87171;
        }

        /* Center Panel - Main Content */
        .content-panel {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .section-header {
            margin-bottom: 24px;
        }

        .section-header h2 {
            font-size: 24px;
            color: #fff;
            margin-bottom: 8px;
        }

        .section-header .meta {
            font-size: 14px;
            color: #888;
        }

        .promotion-score-card {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .score-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .score-title {
            font-size: 14px;
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .score-value {
            font-size: 32px;
            font-weight: 700;
            color: #fff;
        }

        .score-status {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 4px;
            font-weight: 600;
        }

        .signals-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 16px;
        }

        .signal-item {
            background: rgba(255,255,255,0.03);
            padding: 12px;
            border-radius: 6px;
        }

        .signal-name {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .signal-value {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
        }

        .ontology-section {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .ontology-section h3 {
            font-size: 16px;
            color: #fff;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ontology-section h3::before {
            content: '';
            width: 4px;
            height: 16px;
            background: #4a4aff;
            border-radius: 2px;
        }

        .fact-item {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            padding: 10px 0;
            border-bottom: 1px solid #2a2a2a;
        }

        .fact-item:last-child {
            border-bottom: none;
        }

        .fact-label {
            font-size: 13px;
            color: #aaa;
            text-transform: capitalize;
        }

        .fact-value {
            font-size: 16px;
            color: #fff;
            font-weight: 500;
        }

        .fact-confidence {
            font-size: 11px;
            color: #666;
            margin-left: 8px;
        }

        .fact-sources {
            font-size: 11px;
            color: #888;
            margin-left: 4px;
        }

        .story-text {
            line-height: 1.6;
            color: #ccc;
            font-size: 14px;
        }

        .timeline-item {
            display: flex;
            gap: 16px;
            padding: 12px 0;
            border-left: 2px solid #333;
            padding-left: 20px;
            margin-left: 8px;
            position: relative;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -6px;
            top: 18px;
            width: 10px;
            height: 10px;
            background: #4a4aff;
            border-radius: 50%;
        }

        .timeline-time {
            font-size: 12px;
            color: #888;
            min-width: 140px;
        }

        .timeline-text {
            font-size: 13px;
            color: #ccc;
        }

        /* Right Panel - Artifact Submission */
        .submission-panel {
            width: 320px;
            background: #111;
            border-left: 1px solid #333;
            padding: 20px;
            overflow-y: auto;
        }

        .submission-panel h3 {
            font-size: 14px;
            color: #fff;
            margin-bottom: 16px;
        }

        .url-input {
            width: 100%;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 12px;
            color: #fff;
            font-size: 14px;
            margin-bottom: 12px;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        .url-input:focus {
            outline: none;
            border-color: #4a4aff;
        }

        .submit-btn {
            width: 100%;
            background: #4a4aff;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .submit-btn:hover {
            background: #3a3aef;
        }

        .submit-btn:disabled {
            background: #2a2a2a;
            color: #666;
            cursor: not-allowed;
        }

        .recent-pages {
            margin-top: 32px;
        }

        .recent-pages h4 {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .page-item {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .page-item-title {
            color: #fff;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .page-item-meta {
            color: #666;
            font-size: 11px;
        }

        .promote-action {
            background: #3a1a1a;
            border: 1px solid #f87171;
            border-radius: 8px;
            padding: 16px;
            margin-top: 24px;
        }

        .promote-action h4 {
            color: #f87171;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .promote-action p {
            color: #ccc;
            font-size: 12px;
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .promote-buttons {
            display: flex;
            gap: 8px;
        }

        .promote-btn {
            flex: 1;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .promote-btn-yes {
            background: #f87171;
            color: #fff;
        }

        .promote-btn-yes:hover {
            background: #dc2626;
        }

        .promote-btn-no {
            background: #2a2a2a;
            color: #ccc;
        }

        .promote-btn-no:hover {
            background: #333;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state h3 {
            font-size: 18px;
            margin-bottom: 8px;
        }

        .empty-state p {
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="event-title" id="eventTitle">Hong Kong Fire at Wang Fuk Court</div>
        <div class="event-meta" id="eventMeta">Loading...</div>
    </div>

    <div class="container">
        <!-- Left Panel: Section List -->
        <div class="sections-panel">
            <h3>Sections</h3>
            <div class="section-list" id="sectionList"></div>
        </div>

        <!-- Center Panel: Main Content -->
        <div class="content-panel" id="contentPanel">
            <div class="empty-state">
                <h3>Select a section</h3>
                <p>Choose a section from the left to view its details</p>
            </div>
        </div>

        <!-- Right Panel: Artifact Submission -->
        <div class="submission-panel">
            <h3>Add Artifact</h3>
            <input type="text" class="url-input" id="urlInput" placeholder="Paste URL here...">
            <button class="submit-btn" id="submitBtn">Submit</button>

            <div class="recent-pages">
                <h4>Recent Artifacts</h4>
                <div id="recentPages"></div>
            </div>
        </div>
    </div>

    <script>
        // Load section data from test results
        let eventData = null;

        function transformEventData(rawData) {
            // Transform raw FactBelief data into UI-friendly format
            const transformed = {
                event_id: rawData.event_id,
                artifact_count: rawData.artifact_count || 0,
                sections: {}
            };

            for (const [key, section] of Object.entries(rawData.sections)) {
                transformed.sections[key] = {
                    name: section.name,
                    semantic_type: section.semantic_type,
                    page_count: section.page_count || 0,
                    promotion_score: section.promotion_score || 0,
                    promotion_signals: section.promotion_signals || {},
                    ontology: {}
                };

                // Transform ontology
                if (section.ontology) {
                    // Story
                    if (section.ontology.story) {
                        transformed.sections[key].ontology.story = section.ontology.story;
                    }

                    // Casualties
                    if (section.ontology.casualties) {
                        transformed.sections[key].ontology.casualties = {};
                        for (const [type, belief] of Object.entries(section.ontology.casualties)) {
                            transformed.sections[key].ontology.casualties[type] = {
                                current_value: belief.current_value,
                                current_confidence: belief.current_confidence,
                                timeline: belief.timeline || []
                            };
                        }
                    }

                    // Timeline
                    if (section.ontology.timeline) {
                        transformed.sections[key].ontology.timeline = {};
                        if (section.ontology.timeline.start) {
                            transformed.sections[key].ontology.timeline.start = {
                                current_value: section.ontology.timeline.start.current_value || section.ontology.timeline.start
                            };
                        }
                        if (section.ontology.timeline.milestones) {
                            transformed.sections[key].ontology.timeline.milestones = section.ontology.timeline.milestones;
                        }
                    }

                    // Locations
                    if (section.ontology.locations) {
                        transformed.sections[key].ontology.locations = {};
                        for (const [type, belief] of Object.entries(section.ontology.locations)) {
                            transformed.sections[key].ontology.locations[type] = {
                                current_value: belief.current_value,
                                current_confidence: belief.current_confidence
                            };
                        }
                    }

                    // Response
                    if (section.ontology.response) {
                        transformed.sections[key].ontology.response = {};
                        for (const [type, belief] of Object.entries(section.ontology.response)) {
                            transformed.sections[key].ontology.response[type] = {
                                current_value: belief.current_value,
                                current_confidence: belief.current_confidence,
                                timeline: belief.timeline || []
                            };
                        }
                    }
                }
            }

            return transformed;
        }

        async function loadEventData() {
            // Try to load real test data first
            try {
                const response = await fetch('/event_data.json');
                if (response.ok) {
                    const rawData = await response.json();
                    // Transform the data for display
                    eventData = transformEventData(rawData);
                    renderSections();
                    return;
                }
            } catch (error) {
                console.log('Could not load event_data.json, using fallback data', error);
            }

            // Fallback to demo data
                eventData = {
                    event_id: "test-event-hk-fire",
                    artifact_count: 5,
                    sections: {
                        main: {
                            name: "Main Event",
                            semantic_type: "primary",
                            page_count: 0,
                            promotion_score: 0.0
                        },
                        response: {
                            name: "Emergency Response",
                            semantic_type: "response",
                            page_count: 4,
                            promotion_score: 0.420,
                            promotion_signals: {
                                temporal_gap: 0.30,
                                entity_divergence: 0.50,
                                semantic_shift: 0.40,
                                page_density: 0.70,
                                human_weight: 0.00
                            },
                            ontology: {
                                casualties: {
                                    deaths: {
                                        current_value: 44,
                                        current_confidence: 0.98,
                                        timeline: [{}, {}, {}, {}] // 4 sources
                                    },
                                    missing: {
                                        current_value: 279,
                                        current_confidence: 0.98,
                                        timeline: [{}, {}, {}, {}]
                                    },
                                    injured: {
                                        current_value: 29,
                                        current_confidence: 0.98,
                                        timeline: [{}, {}, {}]
                                    }
                                },
                                timeline: {
                                    start: {
                                        current_value: "2025-11-26T14:51:00"
                                    },
                                    milestones: [
                                        { event: "upgraded to level 5", time: "2025-11-26T18:22:00" }
                                    ]
                                },
                                story: {
                                    description: "On November 26, 2025, a massive fire broke out at the Wang Fuk Court housing complex in Tai Po, Hong Kong, resulting in at least 44 fatalities and leaving 279 people missing. Firefighters battled the blaze, which engulfed multiple high-rise buildings, while evacuating around 700 residents and arresting three men on suspicion of manslaughter."
                                }
                            }
                        },
                        related_incident: {
                            name: "Related Incident",
                            semantic_type: "related_incident",
                            page_count: 1,
                            promotion_score: 0.320,
                            promotion_signals: {
                                temporal_gap: 0.30,
                                entity_divergence: 0.50,
                                semantic_shift: 0.40,
                                page_density: 0.20,
                                human_weight: 0.00
                            },
                            ontology: {
                                story: {
                                    description: "The Hong Kong fire has drawn comparisons to the Grenfell Tower fire, highlighting concerns about bamboo scaffolding and building safety regulations."
                                }
                            }
                        }
                    }
                };
                renderSections();
            }
        }

        function getPromotionBadge(score) {
            if (score >= 0.6) return { class: 'badge-promotable', text: 'ðŸ”´ PROMOTABLE' };
            if (score >= 0.45) return { class: 'badge-review', text: 'ðŸŸ¡ REVIEW' };
            return { class: 'badge-stable', text: 'ðŸŸ¢ STABLE' };
        }

        function renderSections() {
            // Update header
            const sectionCount = Object.keys(eventData.sections).length;
            const nonEmptySections = Object.values(eventData.sections).filter(s => s.page_count > 0).length;
            document.getElementById('eventMeta').textContent =
                `${eventData.artifact_count} artifacts â€¢ ${nonEmptySections} sections (${sectionCount} total) â€¢ Last updated: ${new Date().toLocaleDateString()}`;

            const sectionList = document.getElementById('sectionList');
            sectionList.innerHTML = '';

            for (const [key, section] of Object.entries(eventData.sections)) {
                const item = document.createElement('div');
                item.className = 'section-item';
                item.dataset.key = key;

                const score = typeof section.promotion_score === 'number'
                    ? section.promotion_score
                    : section.promotion_score?.total || 0.0;
                const badge = getPromotionBadge(score);

                item.innerHTML = `
                    <div class="section-name">${section.name}</div>
                    <div class="section-type">${section.semantic_type}</div>
                    <div class="section-stats">
                        <span class="page-count">${section.page_count} pages</span>
                        ${key !== 'main' ? `<span class="promotion-badge ${badge.class}">${badge.text}</span>` : ''}
                    </div>
                `;

                item.addEventListener('click', () => selectSection(key));
                sectionList.appendChild(item);
            }

            // Auto-select first non-empty section
            const firstSection = Object.keys(eventData.sections).find(k =>
                eventData.sections[k].page_count > 0
            );
            if (firstSection) selectSection(firstSection);
        }

        function selectSection(key) {
            // Update active state
            document.querySelectorAll('.section-item').forEach(item => {
                item.classList.toggle('active', item.dataset.key === key);
            });

            // Render section content
            const section = eventData.sections[key];
            const contentPanel = document.getElementById('contentPanel');

            let html = `
                <div class="section-header">
                    <h2>${section.name}</h2>
                    <div class="meta">${section.semantic_type} â€¢ ${section.page_count} pages</div>
                </div>
            `;

            // Promotion score (if not main section)
            if (key !== 'main' && section.promotion_score) {
                const score = typeof section.promotion_score === 'number'
                    ? section.promotion_score
                    : section.promotion_score.total || 0.0;
                const signals = section.promotion_signals || {};
                const badge = getPromotionBadge(score);

                html += `
                    <div class="promotion-score-card">
                        <div class="score-header">
                            <div>
                                <div class="score-title">Promotion Score</div>
                                <div class="score-value">${score.toFixed(3)}</div>
                            </div>
                            <span class="score-status ${badge.class}">${badge.text}</span>
                        </div>
                        <div class="signals-grid">
                            <div class="signal-item">
                                <div class="signal-name">Temporal Gap</div>
                                <div class="signal-value">${(signals.temporal_gap || 0).toFixed(2)}</div>
                            </div>
                            <div class="signal-item">
                                <div class="signal-name">Entity Divergence</div>
                                <div class="signal-value">${(signals.entity_divergence || 0).toFixed(2)}</div>
                            </div>
                            <div class="signal-item">
                                <div class="signal-name">Semantic Shift</div>
                                <div class="signal-value">${(signals.semantic_shift || 0).toFixed(2)}</div>
                            </div>
                            <div class="signal-item">
                                <div class="signal-name">Page Density</div>
                                <div class="signal-value">${(signals.page_density || 0).toFixed(2)}</div>
                            </div>
                        </div>
                    </div>
                `;

                // Promote action (if promotable)
                if (score >= 0.45) {
                    html += `
                        <div class="promote-action">
                            <h4>${score >= 0.6 ? 'ðŸ”´ Section is Promotable' : 'ðŸŸ¡ Section in Review Zone'}</h4>
                            <p>This section has ${score >= 0.6 ? 'sufficient' : 'moderate'} signals to become a separate event. Should it be promoted?</p>
                            <div class="promote-buttons">
                                <button class="promote-btn promote-btn-yes" onclick="promoteSection('${key}')">Promote to Event</button>
                                <button class="promote-btn promote-btn-no" onclick="keepSection('${key}')">Keep Together</button>
                            </div>
                        </div>
                    `;
                }
            }

            // Ontology
            if (section.ontology) {
                // Story
                if (section.ontology.story?.description) {
                    html += `
                        <div class="ontology-section">
                            <h3>Story</h3>
                            <div class="story-text">${section.ontology.story.description}</div>
                        </div>
                    `;
                }

                // Casualties
                if (section.ontology.casualties) {
                    html += `<div class="ontology-section"><h3>Casualties</h3>`;
                    for (const [type, belief] of Object.entries(section.ontology.casualties)) {
                        if (belief.current_value !== null) {
                            html += `
                                <div class="fact-item">
                                    <span class="fact-label">${type}</span>
                                    <span>
                                        <span class="fact-value">${belief.current_value}</span>
                                        <span class="fact-confidence">${(belief.current_confidence * 100).toFixed(0)}%</span>
                                        <span class="fact-sources">(${belief.timeline?.length || 1} sources)</span>
                                    </span>
                                </div>
                            `;
                        }
                    }
                    html += `</div>`;
                }

                // Timeline
                if (section.ontology.timeline) {
                    html += `<div class="ontology-section"><h3>Timeline</h3>`;
                    if (section.ontology.timeline.start) {
                        const startVal = section.ontology.timeline.start.current_value || section.ontology.timeline.start;
                        html += `
                            <div class="timeline-item">
                                <div class="timeline-time">${new Date(startVal).toLocaleString()}</div>
                                <div class="timeline-text">Fire started</div>
                            </div>
                        `;
                    }
                    if (section.ontology.timeline.milestones) {
                        section.ontology.timeline.milestones.forEach(m => {
                            html += `
                                <div class="timeline-item">
                                    <div class="timeline-time">${new Date(m.time).toLocaleString()}</div>
                                    <div class="timeline-text">${m.event}</div>
                                </div>
                            `;
                        });
                    }
                    html += `</div>`;
                }

                // Response
                if (section.ontology.response) {
                    html += `<div class="ontology-section"><h3>Response</h3>`;
                    for (const [type, belief] of Object.entries(section.ontology.response)) {
                        if (belief.current_value !== null) {
                            html += `
                                <div class="fact-item">
                                    <span class="fact-label">${type}</span>
                                    <span>
                                        <span class="fact-value">${belief.current_value}</span>
                                        <span class="fact-confidence">${(belief.current_confidence * 100).toFixed(0)}%</span>
                                        <span class="fact-sources">(${belief.timeline?.length || 1} sources)</span>
                                    </span>
                                </div>
                            `;
                        }
                    }
                    html += `</div>`;
                }

                // Locations
                if (section.ontology.locations) {
                    html += `<div class="ontology-section"><h3>Locations</h3>`;
                    for (const [type, belief] of Object.entries(section.ontology.locations)) {
                        if (belief.current_value !== null) {
                            html += `
                                <div class="fact-item">
                                    <span class="fact-label">${type}</span>
                                    <span>
                                        <span class="fact-value">${belief.current_value}</span>
                                        <span class="fact-confidence">${(belief.current_confidence * 100).toFixed(0)}%</span>
                                    </span>
                                </div>
                            `;
                        }
                    }
                    html += `</div>`;
                }
            }

            contentPanel.innerHTML = html;
        }

        function promoteSection(key) {
            alert(`Promoting section "${eventData.sections[key].name}" to separate event...`);
            // TODO: API call to promote
        }

        function keepSection(key) {
            // Adjust human weight downward
            if (eventData.sections[key].promotion_signals) {
                eventData.sections[key].promotion_signals.human_weight = -0.3;
                eventData.sections[key].promotion_score = calculatePromotionScore(eventData.sections[key].promotion_signals);
                renderSections();
                selectSection(key);
            }
        }

        function calculatePromotionScore(signals) {
            return signals.temporal_gap * 0.25 +
                   signals.entity_divergence * 0.25 +
                   signals.semantic_shift * 0.20 +
                   signals.page_density * 0.20 +
                   signals.human_weight * 0.10;
        }

        // Recent pages
        const recentPages = [
            { title: "LiveNow: Hong Kong fire", time: "20:39" },
            { title: "NYPost: 36 killed in blaze", time: "20:40" },
            { title: "Newsweek: 44 dead, hundreds missing", time: "22:41" },
            { title: "DW: Death toll rises", time: "22:52" },
            { title: "NYTimes: Grenfell comparison", time: "23:32" }
        ];

        document.getElementById('recentPages').innerHTML = recentPages.map(p => `
            <div class="page-item">
                <div class="page-item-title">${p.title}</div>
                <div class="page-item-meta">${p.time}</div>
            </div>
        `).join('');

        // Submit button
        document.getElementById('submitBtn').addEventListener('click', () => {
            const url = document.getElementById('urlInput').value;
            if (url) {
                alert(`Submitting: ${url}`);
                // TODO: API call
                document.getElementById('urlInput').value = '';
            }
        });

        // Load data on page load
        loadEventData();
    </script>
</body>
</html>
