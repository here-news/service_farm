<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Sections - Hong Kong Fire</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, sans-serif; background: #0a0a0a; color: #e0e0e0; }
        .header { background: #1a1a1a; padding: 20px; border-bottom: 1px solid #333; }
        .container { display: flex; height: calc(100vh - 80px); }
        .sidebar { width: 280px; background: #111; border-right: 1px solid #333; overflow-y: auto; padding: 16px; }
        .content { flex: 1; padding: 24px; overflow-y: auto; }
        .section-item { background: #1a1a1a; border: 1px solid #333; padding: 12px; margin-bottom: 8px; cursor: pointer; border-radius: 6px; }
        .section-item:hover { background: #222; }
        .section-item.active { border-color: #4a4aff; background: #2a2a3a; }
        .badge { font-size: 10px; padding: 2px 6px; border-radius: 3px; display: inline-block; margin-top: 4px; }
        .badge-stable { background: #1a3a1a; color: #4ade80; }
        .badge-review { background: #3a3a1a; color: #fbbf24; }
        .badge-promotable { background: #3a1a1a; color: #f87171; }
        .ontology-section { background: #1a1a1a; border: 1px solid #333; padding: 20px; margin-bottom: 16px; border-radius: 8px; }
        .ontology-section h3 { margin-bottom: 12px; color: #fff; }
        .fact-row { padding: 8px 0; border-bottom: 1px solid #2a2a2a; display: flex; justify-content: space-between; }
        .fact-row:last-child { border-bottom: none; }
        .story { line-height: 1.6; color: #ccc; }
    </style>
</head>
<body>
    <div class="header">
        <h1 id="title">Hong Kong Fire Event</h1>
        <p id="meta" style="color: #888; margin-top: 4px;">Loading...</p>
    </div>
    <div class="container">
        <div class="sidebar" id="sidebar"></div>
        <div class="content" id="content">
            <p style="color: #666;">Select a section from the left</p>
        </div>
    </div>

    <script>
        let data = null;
        let selectedKey = null;

        fetch('/event_data.json')
            .then(r => {
                if (!r.ok) throw new Error('Failed to load');
                return r.json();
            })
            .then(raw => {
                data = raw;
                console.log('Loaded data:', data);
                render();
            })
            .catch(e => {
                console.error('Load error:', e);
                document.getElementById('content').innerHTML = '<p style="color:red;">Error loading data: ' + e.message + '</p>';
            });

        function render() {
            if (!data) return;

            // Update header
            const count = Object.values(data.sections).filter(s => s.page_count > 0).length;
            document.getElementById('meta').textContent = `${data.artifact_count || 0} artifacts â€¢ ${count} active sections`;

            // Render sidebar
            const sidebar = document.getElementById('sidebar');
            sidebar.innerHTML = '<h3 style="color:#666;font-size:12px;margin-bottom:12px;">SECTIONS</h3>';

            for (const [key, section] of Object.entries(data.sections)) {
                const div = document.createElement('div');
                div.className = 'section-item';
                if (key === selectedKey) div.classList.add('active');

                const score = typeof section.promotion_score === 'number' ? section.promotion_score :
                             (section.promotion_score?.total || 0);
                let badge = '';
                if (key !== 'main' && score > 0) {
                    const badgeClass = score >= 0.6 ? 'badge-promotable' :
                                      score >= 0.45 ? 'badge-review' : 'badge-stable';
                    const badgeText = score >= 0.6 ? 'ðŸ”´ PROMOTABLE' :
                                     score >= 0.45 ? 'ðŸŸ¡ REVIEW' : 'ðŸŸ¢ STABLE';
                    badge = `<span class="badge ${badgeClass}">${badgeText}</span>`;
                }

                div.innerHTML = `
                    <div style="font-weight:600;margin-bottom:4px;">${section.name}</div>
                    <div style="font-size:11px;color:#888;">${section.semantic_type} â€¢ ${section.page_count} pages</div>
                    ${badge}
                `;
                div.onclick = () => selectSection(key);
                sidebar.appendChild(div);
            }

            // Auto-select first non-empty
            if (!selectedKey) {
                const first = Object.keys(data.sections).find(k => data.sections[k].page_count > 0);
                if (first) selectSection(first);
            }
        }

        function selectSection(key) {
            selectedKey = key;
            render();

            const section = data.sections[key];
            const content = document.getElementById('content');
            let html = `<h2>${section.name}</h2><p style="color:#888;margin-bottom:24px;">${section.semantic_type} â€¢ ${section.page_count} pages</p>`;

            // Promotion score
            if (key !== 'main' && section.promotion_score) {
                const score = typeof section.promotion_score === 'number' ? section.promotion_score : section.promotion_score.total || 0;
                const signals = section.promotion_signals || {};
                html += `<div class="ontology-section">
                    <h3>Promotion Score: ${score.toFixed(3)}</h3>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px;">
                        <div>Temporal Gap: <strong>${(signals.temporal_gap || 0).toFixed(2)}</strong></div>
                        <div>Entity Divergence: <strong>${(signals.entity_divergence || 0).toFixed(2)}</strong></div>
                        <div>Semantic Shift: <strong>${(signals.semantic_shift || 0).toFixed(2)}</strong></div>
                        <div>Page Density: <strong>${(signals.page_density || 0).toFixed(2)}</strong></div>
                    </div>
                </div>`;
            }

            // Story
            if (section.ontology?.story?.description) {
                html += `<div class="ontology-section">
                    <h3>Story</h3>
                    <div class="story">${section.ontology.story.description}</div>
                </div>`;
            }

            // Casualties
            if (section.ontology?.casualties) {
                html += `<div class="ontology-section"><h3>Casualties</h3>`;
                for (const [type, belief] of Object.entries(section.ontology.casualties)) {
                    if (belief.current_value != null) {
                        const sources = belief.timeline?.length || 1;
                        html += `<div class="fact-row">
                            <span>${type}</span>
                            <span><strong>${belief.current_value}</strong> (${(belief.current_confidence * 100).toFixed(0)}%, ${sources} sources)</span>
                        </div>`;
                    }
                }
                html += `</div>`;
            }

            // Response
            if (section.ontology?.response) {
                html += `<div class="ontology-section"><h3>Response</h3>`;
                for (const [type, belief] of Object.entries(section.ontology.response)) {
                    if (belief.current_value != null) {
                        const sources = belief.timeline?.length || 1;
                        html += `<div class="fact-row">
                            <span>${type}</span>
                            <span><strong>${belief.current_value}</strong> (${(belief.current_confidence * 100).toFixed(0)}%, ${sources} sources)</span>
                        </div>`;
                    }
                }
                html += `</div>`;
            }

            // Timeline
            if (section.ontology?.timeline) {
                html += `<div class="ontology-section"><h3>Timeline</h3>`;
                if (section.ontology.timeline.start) {
                    const start = section.ontology.timeline.start.current_value || section.ontology.timeline.start;
                    html += `<div class="fact-row"><span>Start</span><span>${new Date(start).toLocaleString()}</span></div>`;
                }
                if (section.ontology.timeline.milestones) {
                    section.ontology.timeline.milestones.forEach(m => {
                        html += `<div class="fact-row"><span>${m.event}</span><span>${new Date(m.time).toLocaleString()}</span></div>`;
                    });
                }
                html += `</div>`;
            }

            // Locations
            if (section.ontology?.locations) {
                html += `<div class="ontology-section"><h3>Locations</h3>`;
                for (const [type, belief] of Object.entries(section.ontology.locations)) {
                    if (belief.current_value != null) {
                        html += `<div class="fact-row">
                            <span>${type}</span>
                            <span><strong>${belief.current_value}</strong> (${(belief.current_confidence * 100).toFixed(0)}%)</span>
                        </div>`;
                    }
                }
                html += `</div>`;
            }

            content.innerHTML = html;
        }
    </script>
</body>
</html>
